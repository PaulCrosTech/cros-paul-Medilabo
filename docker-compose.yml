name: Medilabo

services:

  # Eureka Microservice
  ms-eureka:
    build: ./ms-eureka
    container_name: medilabo_ms_eureka
    healthcheck:
      test: [ "CMD", "sh", "-c", "curl -s http://localhost:9002/actuator/health | jq -e '.status == \"UP\"' > /dev/null && exit 0 || exit 1" ]
      interval: 30s
      retries: 5
      timeout: 5s
    networks:
      - rsx-backend


  # Config Microservice
  ms-config:
    build: ./ms-config
    container_name: medilabo_ms_config
    healthcheck:
      test: [ "CMD", "sh", "-c", "curl -s http://localhost:9088/actuator/health | jq -e '.status == \"UP\"' > /dev/null && exit 0 || exit 1" ]
      interval: 30s
      retries: 5
      timeout: 5s
    depends_on:
      ms-eureka:
        condition: service_healthy
    environment:
      SPRING_PROFILES_ACTIVE: ${SPRING_PROFILES_ACTIVE}
      GIT_CREDENTIALS: /run/secrets/secrets_ms_config_git_credentials
    networks:
      - rsx-backend
    secrets:
      - secrets_ms_config_git_credentials
    tmpfs:
      - /run/secrets

  # MySQL Database Service
  dbMySQL:
    image: mysql:8.0
    container_name: medilabo_db_mysql
    environment:
      MYSQL_DATABASE: medilabo_patient
      MYSQL_USER: ${MYSQL_USER}
      MYSQL_PASSWORD: ${MYSQL_PASSWORD}
      MYSQL_ALLOW_EMPTY_PASSWORD: true
    networks:
      - rsx-backend
    volumes:
      - ./ms-patient/src/main/resources/docker/ms_patient_data.sql:/docker-entrypoint-initdb.d/ms_patient_data.sql:ro
      - mysql-for-MsPatient:/var/lib/mysql
    healthcheck:
      test: [ "CMD", "mysqladmin" ,"ping", "-h", "localhost", "-u", "root" ]
      interval: 30s
      retries: 5
      timeout: 5s

  # MongoDB Database Service
  dbMongoDB:
    image: mongo:latest
    container_name: medilabo_db_mongodb
    environment:
      MONGO_INITDB_DATABASE: medilabo_note
      MONGO_INITDB_DATABASE_USER: ${MONGODB_USER}
      MONGO_INITDB_DATABASE_PASSWORD: ${MONGODB_PASSWORD}
    volumes:
      - ./ms-note/src/main/resources/mongodb-init-docker.js:/docker-entrypoint-initdb.d/mongodb-init-docker.js:ro
      - mongoDB-for-MsNote:/data/db
    networks:
      - rsx-backend
    healthcheck:
      test: [ "CMD", "mongosh", "--eval", "db.adminCommand('ping')" ]
      interval: 30s
      retries: 5
      timeout: 5s

  # Patient Microservice
  ms-patient:
    build: ./ms-patient
    container_name: medilabo_ms_patient
    healthcheck:
      test: [ "CMD", "sh", "-c", "curl -s http://localhost:9005/actuator/health | jq -e '.status == \"UP\"' > /dev/null && exit 0 || exit 1" ]
      interval: 30s
      retries: 5
      timeout: 5s
    depends_on:
      ms-config:
        condition: service_healthy
      dbMySQL:
        condition: service_healthy
    networks:
      - rsx-backend
    environment:
      MYSQL_USER: ${MYSQL_USER}
      MYSQL_PASSWORD: ${MYSQL_PASSWORD}
      SPRING_PROFILES_ACTIVE: ${SPRING_PROFILES_ACTIVE}

    # Note Microservice
  ms-note:
    build: ./ms-note
    container_name: medilabo_ms_note
    healthcheck:
      test: [ "CMD", "sh", "-c", "curl -s http://localhost:9006/actuator/health | jq -e '.status == \"UP\"' > /dev/null && exit 0 || exit 1" ]
      interval: 30s
      retries: 5
      timeout: 5s
    depends_on:
      ms-config:
        condition: service_healthy
      dbMongoDB:
        condition: service_healthy
    networks:
      - rsx-backend
    environment:
      MONGODB_USER: ${MONGODB_USER}
      MONGODB_PASSWORD: ${MONGODB_PASSWORD}
      SPRING_PROFILES_ACTIVE: ${SPRING_PROFILES_ACTIVE}

  # Risk Microservice
  ms-riskassessment:
    build: ./ms-riskassessment
    container_name: medilabo_ms_riskassessment
    healthcheck:
      test: [ "CMD", "sh", "-c", "curl -s http://localhost:9007/actuator/health | jq -e '.status == \"UP\"' > /dev/null && exit 0 || exit 1" ]
      interval: 30s
      retries: 5
      timeout: 5s
    depends_on:
      ms-config:
        condition: service_healthy
    networks:
      - rsx-backend
    environment:
      SPRING_PROFILES_ACTIVE: ${SPRING_PROFILES_ACTIVE}

  # Gateway Microservice
  ms-gateway:
    build: ./ms-gateway
    container_name: medilabo_ms_gateway
    ports:
      - "9001:9001"
    healthcheck:
      test: [ "CMD", "sh", "-c", "curl -s http://localhost:9001/actuator/health | jq -e '.status == \"UP\"' > /dev/null && exit 0 || exit 1" ]
      interval: 30s
      retries: 5
      timeout: 5s
    depends_on:
      ms-note:
        condition: service_healthy
      ms-riskassessment:
        condition: service_healthy
      ms-patient:
        condition: service_healthy
    networks:
      - rsx-backend
    environment:
      SPRING_PROFILES_ACTIVE: ${SPRING_PROFILES_ACTIVE}
      MS_GATEWAY_USER: ${MS_GATEWAY_USER}
      MS_GATEWAY_PASSWORD: ${MS_GATEWAY_PASSWORD}

  #   Frontend Service
  frontend:
    build:
      context: ./client-ui/frontend
      args:
        MS_GATEWAY_USER: ${MS_GATEWAY_USER}
        MS_GATEWAY_PASSWORD: ${MS_GATEWAY_PASSWORD}
    container_name: medilabo_frontend
    ports:
      - "9080:9080"
    depends_on:
      ms-gateway:
        condition: service_healthy


# Network Configuration
networks:
  rsx-backend:
    driver: bridge

# Volume Configuration
volumes:
  mongoDB-for-MsNote:
  mysql-for-MsPatient:


# Configuration des secrets
secrets:
  secrets_ms_config_git_credentials:
    file: ./secrets_ms_config_git_credentials.json
